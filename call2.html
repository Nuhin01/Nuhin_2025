<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Audio Broadcast WebApp</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 0 auto;
            padding: 20px;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            margin: 10px;
            font-size: 16px;
            cursor: pointer;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        td {
            padding: 10px;
            border: 1px solid #ddd;
        }
        #media-container {
            margin-top: 20px;
        }
        audio, video {
            width: 100%;
            max-width: 400px;
        }
    </style>
</head>
<body>
    <h1>Real-Time Audio Broadcast</h1>
    <p>This webapp allows you to broadcast your audio in real-time to anyone visiting the same page. Use the button below to start broadcasting (grant mic access). Viewers will see a "Join" button appear and can click to listen.</p>
    <p>For private use, change the room name in the code to something unique and share the page URL with your brother.</p>
    
    <button id="setup-new-broadcast" disabled>Start Audio Broadcast</button>
    
    <table id="rooms-list"></table>
    
    <div id="media-container"></div>
    
    <!-- WebRTC Broadcast Library (CDN from WebRTC-Experiment) -->
    <script src="https://cdn.webrtc-experiment.com/broadcast.js"></script>
    
    <!-- Socket.IO for signaling (public server) -->
    <script src="https://cdn.webrtc-experiment.com/socket.io.js"></script>
    
    <script>
        // Hardcode to audio only
        var isAudio = true;
        var shared = 'audio';
        var constraints = { audio: true, video: false };

        var mediaContainer = document.getElementById('media-container') || document.body;
        var roomsList = document.getElementById('rooms-list');
        var btnSetupNewBroadcast = document.getElementById('setup-new-broadcast');

        // Config for broadcast
        var config = {
            openSocket: function(config) {
                var SIGNALING_SERVER = 'https://socketio-over-nodejs2.herokuapp.com/';
                var channel = config.channel || location.href.replace(/\/|:|#|%|\.|\[|\]/g, '');
                var sender = Math.round(Math.random() * 999999999) + 999999999;

                io.connect(SIGNALING_SERVER).emit('new-channel', {
                    channel: channel,
                    sender: sender
                });

                var socket = io.connect(SIGNALING_SERVER + channel);
                socket.channel = channel;
                socket.on('connect', function () {
                    if (config.callback) config.callback(socket);
                });

                socket.send = function (message) {
                    socket.emit('message', {
                        sender: sender,
                        data: message
                    });
                };

                socket.on('message', config.onmessage);
            },
            onRemoteStream: function(htmlElement) {
                htmlElement.muted = false; // For audio only, but using video element for compatibility
                htmlElement.volume = 1;
                mediaContainer.appendChild(htmlElement);
            },
            onRoomFound: function(room) {
                var alreadyExist = document.querySelector('button[data-broadcaster="' + room.broadcaster + '"]');
                if (alreadyExist) return;

                var tr = document.createElement('tr');
                tr.innerHTML = '<td><strong>' + room.roomName + '</strong> is broadcasting audio!</td>' +
                               '<td><button class="join">Join Broadcast</button></td>';
                roomsList.appendChild(tr);

                var joinRoomButton = tr.querySelector('.join');
                joinRoomButton.setAttribute('data-broadcaster', room.broadcaster);
                joinRoomButton.setAttribute('data-roomToken', room.roomToken);
                joinRoomButton.onclick = function() {
                    this.disabled = true;
                    var broadcaster = this.getAttribute('data-broadcaster');
                    var roomToken = this.getAttribute('data-roomToken');
                    broadcastUI.joinRoom({
                        roomToken: roomToken,
                        joinUser: broadcaster
                    });
                };
            },
            onNewParticipant: function(numberOfViewers) {
                document.title = 'Listeners: ' + numberOfViewers;
                alert(numberOfViewers + ' listeners connected!');
            },
            onReady: function() {
                console.log('Socket is ready');
                btnSetupNewBroadcast.disabled = false;
            }
        };

        var broadcastUI = broadcast(config);

        // Start broadcast button
        btnSetupNewBroadcast.onclick = function() {
            this.disabled = true;
            captureUserMedia(function() {
                broadcastUI.createRoom({
                    roomName: 'family-audio-broadcast', // Change this for private room
                    isAudio: isAudio
                });
            });
        };

        // Capture media
        function captureUserMedia(callback) {
            navigator.mediaDevices.getUserMedia(constraints)
                .then(function(stream) {
                    callback && callback();
                })
                .catch(function(error) {
                    alert('Unable to access microphone: ' + error.message);
                });
        }
    </script>
</body>
</html>
