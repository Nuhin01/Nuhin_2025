<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bluetooth Headphone Audio Recorder</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            background-color: #f4f4f4;
        }
        h1 {
            margin-bottom: 20px;
        }
        select, button, input {
            margin: 10px;
            padding: 10px;
            font-size: 16px;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            border-radius: 5px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        a {
            margin: 10px;
            padding: 10px 20px;
            background-color: #28a745;
            color: white;
            text-decoration: none;
            border-radius: 5px;
            display: none;
        }
        a:hover {
            background-color: #218838;
        }
        #status {
            margin: 10px;
            color: #555;
        }
    </style>
</head>
<body>
    <h1>Audio Recorder from Bluetooth Headphone Mic</h1>
    <p>Select your microphone device (choose your Bluetooth headphone mic if available):</p>
    <select id="deviceSelect"></select>
    <label>
        <input type="checkbox" id="volumeBoost" checked> Enhance voice volume 10x (default: on, may cause distortion)
    </label>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <a id="downloadLink" download="recording.webm">Download Recording</a>
    <p id="status"></p>

    <script>
        let mediaRecorder;
        let audioChunks = [];
        let audioStream;
        let audioContext;
        const deviceSelect = document.getElementById('deviceSelect');
        const startBtn = document.getElementById('startBtn');
        const stopBtn = document.getElementById('stopBtn');
        const downloadLink = document.getElementById('downloadLink');
        const status = document.getElementById('status');
        const volumeBoost = document.getElementById('volumeBoost');

        // Initialize device list after getting permission
        async function populateDevices() {
            try {
                // Request permission to access audio
                await navigator.mediaDevices.getUserMedia({ audio: true });
                
                // Enumerate devices
                const devices = await navigator.mediaDevices.enumerateDevices();
                const audioInputs = devices.filter(device => device.kind === 'audioinput');
                
                // Clear existing options
                deviceSelect.innerHTML = '';
                
                if (audioInputs.length === 0) {
                    status.textContent = 'No audio input devices found.';
                    return;
                }
                
                audioInputs.forEach(device => {
                    const option = document.createElement('option');
                    option.value = device.deviceId;
                    option.text = device.label || `Microphone ${device.deviceId}`;
                    deviceSelect.appendChild(option);
                });
                
                status.textContent = 'Devices loaded. Select your Bluetooth headphone mic and start recording.';
            } catch (error) {
                console.error('Error accessing media devices:', error);
                status.textContent = 'Error: Could not access microphone. Please check permissions.';
            }
        }

        // Start recording with selected device
        startBtn.addEventListener('click', async () => {
            const selectedDeviceId = deviceSelect.value;
            if (!selectedDeviceId) {
                status.textContent = 'Please select a device first.';
                return;
            }
            
            try {
                const constraints = {
                    audio: {
                        deviceId: { exact: selectedDeviceId }
                    }
                };
                
                audioStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                let recordingStream = audioStream;
                
                if (volumeBoost.checked) {
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(audioStream);
                    const gainNode = audioContext.createGain();
                    gainNode.gain.value = 10; // 10x volume boost
                    const destination = audioContext.createMediaStreamDestination();
                    source.connect(gainNode);
                    gainNode.connect(destination);
                    recordingStream = destination.stream;
                }
                
                mediaRecorder = new MediaRecorder(recordingStream);
                
                mediaRecorder.ondataavailable = event => {
                    audioChunks.push(event.data);
                };
                
                mediaRecorder.onstop = () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    const audioUrl = URL.createObjectURL(audioBlob);
                    downloadLink.href = audioUrl;
                    downloadLink.style.display = 'inline-block';
                    audioChunks = [];
                    status.textContent = 'Recording stopped. Download link available.';
                    if (audioContext) {
                        audioContext.close();
                    }
                };
                
                mediaRecorder.start();
                startBtn.disabled = true;
                stopBtn.disabled = false;
                downloadLink.style.display = 'none';
                status.textContent = 'Recording...';
            } catch (error) {
                console.error('Error starting recording:', error);
                status.textContent = 'Error: Could not start recording. Ensure the device is connected.';
            }
        });

        // Stop recording
        stopBtn.addEventListener('click', () => {
            if (mediaRecorder && mediaRecorder.state !== 'inactive') {
                mediaRecorder.stop();
                audioStream.getTracks().forEach(track => track.stop());
                startBtn.disabled = false;
                stopBtn.disabled = true;
            }
        });

        // Load devices on page load
        window.addEventListener('load', populateDevices);
    </script>
</body>
</html>
